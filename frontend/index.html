<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RouteSafe Navigator v1.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --rs-bg: #020617;
      --rs-card: #020924;
      --rs-text-main: #f9fafb;
      --rs-text-muted: #a7b3d1;
      --rs-accent: #2563eb;
      --rs-border: #1d2750;
      --rs-success: #16a34a;
      --rs-warning: #f59e0b;
      --rs-danger: #dc2626;
    }

    body {
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top left,#0b173d,#020617 52%);
      color:var(--rs-text-main);
    }

    .page { max-width:640px; margin:0 auto; padding:16px; }

    .card {
      background:radial-gradient(circle at top,#07122e,#020617 55%);
      border-radius:24px;
      padding:18px;
      border:1px solid rgba(148,163,184,0.08);
      margin-bottom:14px;
      box-shadow:0 18px 60px rgba(15,23,42,0.75);
    }

    .card-title { font-size:20px; font-weight:700; }
    .subtitle { font-size:12px; color:var(--rs-text-muted); }

    .label { font-size:13px; color:var(--rs-text-muted); margin-bottom:4px; }

    input[type="text"], input[type="number"] {
      width:100%; border-radius:999px; border:1px solid var(--rs-border);
      padding:8px 12px; background: #02071b; color:#fff;
    }

    .btn-primary {
      width:100%; border-radius:999px; border:none;
      background:linear-gradient(135deg,#2563eb,#4f46e5);
      padding:10px 16px; color:#fff; font-weight:600;
      margin-top:12px;
    }

    #map {
      width:100%; height:360px;
      border-radius:18px; overflow:hidden;
    }

    .route-status { margin-top:8px; text-align:right; }
    .status-pill {
      display:inline-block; padding:4px 12px; font-size:11px;
      border-radius:999px; border:1px solid transparent;
    }
    .status-pill.loading { background:rgba(248,113,113,0.15); border-color:rgba(248,113,113,0.8); }
    .status-pill.ok { background:rgba(22,163,74,0.15); border-color:rgba(22,163,74,0.9); }
    .status-pill.error { background:rgba(220,38,38,0.18); border-color:rgba(220,38,38,0.9); }
    .status-pill.idle { border:1px solid rgba(148,163,184,0.4); color:var(--rs-text-muted); }

    /* Camera modal */
    #camera-modal {
      position:fixed; inset:0; background:rgba(0,0,0,0.85);
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    #camera-box {
      background:#020617; border:1px solid #1d2750; border-radius:20px;
      padding:16px; width:90%; max-width:420px;
    }
    #camera-video { width:100%; border-radius:14px; background:black; }

  </style>
</head>
<body>
<div class="page">

  <!-- Header -->
  <section class="card">
    <div class="card-title">RouteSafe Navigator</div>
    <p class="subtitle">Intelligent low-bridge and HGV routing engine.</p>
  </section>

  <!-- Route Planner -->
  <section class="card">
    <div class="card-title">Plan route</div>
    <p class="subtitle">Enter UK postcodes, height and scan reg.</p>

    <form id="route-form">

      <label class="label">Start postcode</label>
      <input id="start-postcode" type="text" placeholder="LS27 0BN"/>

      <label class="label" style="margin-top:10px;">Destination postcode</label>
      <input id="dest-postcode" type="text" placeholder="HD5 0RL"/>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <div style="flex:1;">
          <label class="label">Vehicle height (m)</label>
          <input id="vehicle-height" type="number" step="0.1" placeholder="4.5"/>
        </div>
        <div style="flex:1;">
          <label class="label">Vehicle reg</label>
          <div style="display:flex; gap:6px;">
            <input id="vehicle-reg" type="text" placeholder="YX71 ABC" style="flex:1;"/>
            <button type="button" id="scan-reg-btn"
              style="border-radius:999px; border:1px solid var(--rs-border);
                     background:#02071b; color:#fff; padding:6px 12px;">
              ðŸ“·
            </button>
          </div>
        </div>
      </div>

      <label class="label" style="margin-top:10px;">
        <input id="avoid-low-bridges" checked type="checkbox" />
        Avoid low bridges
      </label>

      <button class="btn-primary" type="submit">Generate safe route</button>

      <div class="route-status">
        <span id="route-status-pill" class="status-pill idle">Ready</span>
      </div>
    </form>
  </section>

  <!-- Summary -->
  <section class="card">
    <div class="card-title">Route summary</div>
    <div style="margin-top:8px;">
      <div class="subtitle">Distance: <span id="summary-distance">-</span></div>
      <div class="subtitle">Time: <span id="summary-time">-</span></div>
      <div class="subtitle">Bridge risk: <span id="bridge-risk-text">-</span></div>
      <div class="subtitle">Nearest bridge: <span id="nearest-bridge-text">-</span></div>
    </div>
    <div id="route-summary-status" class="subtitle" style="margin-top:10px;"></div>
  </section>

  <!-- Map -->
  <section class="card">
    <div class="card-title">Map</div>
    <div id="map"></div>
  </section>

</div>

<!-- CAMERA MODAL -->
<div id="camera-modal">
  <div id="camera-box">
    <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
      <span style="color:#fff;">Scan number plate</span>
      <button id="camera-close" style="background:none; border:none; color:#fff; font-size:18px;">Ã—</button>
    </div>

    <video id="camera-video" autoplay playsinline></video>

    <button id="camera-capture"
      style="margin-top:8px; width:100%; border:none; border-radius:999px;
             padding:10px 0; font-weight:600; background:#2563eb; color:#fff;">
      Capture & detect
    </button>

    <div id="camera-status" style="margin-top:6px; font-size:12px; color:#9ca3af;"></div>
  </div>
</div>

<script>
const API_BASE = "https://routesafe-navigatorv2.onrender.com";

let map, mainRouteLayer, altRouteLayer, bridgeLayer;
let cameraStream = null;

document.addEventListener("DOMContentLoaded", () => {
  // Map
  map = L.map("map").setView([53.8, -1.6], 11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
    .addTo(map);

  mainRouteLayer = L.layerGroup().addTo(map);
  altRouteLayer = L.layerGroup().addTo(map);
  bridgeLayer  = L.layerGroup().addTo(map);

  document.getElementById("route-form")
    .addEventListener("submit", (e) => {
      e.preventDefault();
      generateRoute();
    });

  setupRegCamera();
});

function setRouteStatus(mode, text) {
  const el = document.getElementById("route-status-pill");
  el.className = "status-pill " + mode;
  el.textContent = text;
}

/* ==============================
   REG CAMERA SETUP
============================== */
function setupRegCamera() {
  const scanBtn = document.getElementById("scan-reg-btn");
  const modal   = document.getElementById("camera-modal");
  const video   = document.getElementById("camera-video");
  const closeBtn= document.getElementById("camera-close");
  const snapBtn = document.getElementById("camera-capture");
  const status  = document.getElementById("camera-status");

  scanBtn.onclick = async () => {
    modal.style.display = "flex";
    status.textContent = "Opening cameraâ€¦";

    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode:"environment" }
      });
      video.srcObject = cameraStream;
      status.textContent = "Point at number plate, then tap capture.";
    } catch {
      status.textContent = "Camera blocked.";
    }
  };

  closeBtn.onclick = () => closeCameraModal();
  snapBtn.onclick  = () => captureReg(video, status);
}

function closeCameraModal() {
  const modal = document.getElementById("camera-modal");
  modal.style.display = "none";

  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
  }
}

/* ==============================
   CAPTURE FRAME + SEND TO API
============================== */
async function captureReg(video, statusEl) {
  if (!video.videoWidth) {
    statusEl.textContent = "Camera not ready.";
    return;
  }

  // Draw frame
  const canvas = document.createElement("canvas");
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0,0);

  const blob = await new Promise(res => canvas.toBlob(res,"image/jpeg",0.8));
  const formData = new FormData();
  formData.append("image", blob, "reg.jpg");

  statusEl.textContent = "Detectingâ€¦";

  try {
    const resp = await fetch(`${API_BASE}/api/scan-reg`, {
      method:"POST",
      body: formData
    });
    const data = await resp.json();

    if (!resp.ok) {
      statusEl.textContent = "Error: " + resp.status;
      return;
    }

    const reg = data.reg || "";
    if (!reg) {
      statusEl.textContent = "No plate detected.";
      return;
    }

    document.getElementById("vehicle-reg").value = reg;
    statusEl.textContent = "Detected: " + reg;

    setTimeout(() => closeCameraModal(), 600);

  } catch {
    statusEl.textContent = "Network error.";
  }
}

/* ==============================
   ROUTE GENERATION
============================== */
async function generateRoute() {
  const start = document.getElementById("start-postcode").value.trim();
  const dest  = document.getElementById("dest-postcode").value.trim();
  const height= parseFloat(document.getElementById("vehicle-height").value);
  const avoid = document.getElementById("avoid-low-bridges").checked;

  if (!start || !dest || isNaN(height)) {
    alert("Enter start, dest and height.");
    return;
  }

  setRouteStatus("loading","Searchingâ€¦");

  try {
    const resp = await fetch(`${API_BASE}/api/route`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        start_postcode:start,
        dest_postcode:dest,
        vehicle_height_m:height,
        avoid_low_bridges:avoid
      })
    });

    const text = await resp.text();
    if (!resp.ok) {
      alert("Error " + resp.status + ":\n" + text);
      setRouteStatus("error","Error");
      return;
    }

    const data = JSON.parse(text);
    renderRoute(data);
    updateSummary(data);
    setRouteStatus("ok","Route ready");

  } catch (err) {
    alert("Network error.");
    setRouteStatus("error","Network error");
  }
}

function toLatLng(coords) {
  if (!coords) return [];
  return coords.map(c => [c[0], c[1]]);
}

function renderRoute(data) {
  mainRouteLayer.clearLayers();
  altRouteLayer.clearLayers();
  bridgeLayer.clearLayers();

  const main = toLatLng(data.main_route?.coords);
  if (main.length) {
    const line = L.polyline(main,{color:"#3b82f6",weight:5});
    mainRouteLayer.addLayer(line);
    map.fitBounds(line.getBounds().pad(0.2));
  }

  const alt = toLatLng(data.alt_route?.coords);
  if (alt.length) {
    altRouteLayer.addLayer(
      L.polyline(alt,{color:"#a855f7",weight:3, dashArray:"6 6"})
    );
  }

  (data.bridges||[]).forEach(b=>{
    L.circleMarker([b.lat,b.lon],{
      radius:6, color:"#f97316", fillColor:"#f97316", fillOpacity:1
    }).addTo(bridgeLayer);
  });
}

function updateSummary(data) {
  const m = data.metrics;
  document.getElementById("summary-distance").textContent =
    m.distance_km.toFixed(1)+" km";
  document.getElementById("summary-time").textContent =
    m.duration_min.toFixed(0)+" mins";

  const br = data.bridge_result;
  document.getElementById("bridge-risk-text").textContent = br.risk_level;
  document.getElementById("nearest-bridge-text").textContent =
    br.nearest_bridge_height_m ? br.nearest_bridge_height_m+" m" : "-";
}
</script>

</body>
</html>