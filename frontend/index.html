<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RouteSafe Navigator</title>

<style>
    body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at top left, #0a0f2c, #020617 70%);
        font-family: "Inter", sans-serif;
        color: white;
        overflow-x: hidden;
    }

    .container {
        width: 92%;
        margin: 20px auto;
    }

    h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0;
    }

    .subtitle {
        margin-top: 4px;
        opacity: 0.75;
    }

    .card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 20px;
        margin-top: 24px;
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.08);
    }

    input, select {
        width: 100%;
        margin-top: 8px;
        padding: 14px;
        border-radius: 14px;
        border: none;
        background: rgba(255,255,255,0.12);
        color: white;
        font-size: 1.1rem;
    }

    #generateBtn {
        width: 100%;
        padding: 18px;
        margin-top: 20px;
        border-radius: 30px;
        font-size: 1.25rem;
        font-weight: 700;
        color: white;
        border: none;
        background: linear-gradient(135deg, #3b82f6, #6366f1);
    }

    #statusBadge {
        margin-left: 10px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.9rem;
        background: #444;
    }

    .mapBox {
        margin-top: 20px;
        border-radius: 20px;
        overflow: hidden;
        height: 350px;
    }

    .googleBtn {
        margin-top: 20px;
        width: 100%;
        padding: 16px;
        border-radius: 25px;
        background: rgba(255,255,255,0.12);
        border: 1px solid rgba(255,255,255,0.15);
        font-size: 1.15rem;
        color: white;
    }
</style>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>
<body>

<div class="container">
    <h1>RouteSafe Navigator</h1>
    <div class="subtitle">Intelligent low-bridge & HGV routing.</div>

    <!-- PLAN ROUTE -->
    <div class="card">
        <h2>Plan route</h2>

        <label>Start postcode</label>
        <input id="start" placeholder="LS270BN"/>

        <label>Destination postcode</label>
        <input id="dest" placeholder="HD5 0RL"/>

        <label>Vehicle height (m)</label>
        <input id="height" type="number" step="0.1" value="4"/>

        <label>Vehicle reg (optional)</label>
        <input id="reg" placeholder="e.g. YX71 OXC"/>

        <label style="margin-top:10px;">
            <input type="checkbox" id="avoidBridges" checked/>
            Avoid low bridges
        </label>

        <button id="generateBtn">Generate safe route</button>
        <span id="statusBadge">Idle</span>
    </div>

    <!-- ROUTE SUMMARY -->
    <div class="card">
        <h2>Route summary</h2>
        <div id="summary">No route</div>
    </div>

    <!-- MAP -->
    <div class="card">
        <h2>Map</h2>
        <div id="map" class="mapBox"></div>

        <button class="googleBtn" id="gmapsBtn">Open in Google Maps</button>
    </div>
</div>

<script>
/* ------------------------------------------
   CONFIG: FIXED API ENDPOINT
------------------------------------------- */
const API_URL = "https://routesafe-navigatorv2.onrender.com/api/route";

/* ------------------------------------------
   MAP INITIALISE
------------------------------------------- */
let map = L.map("map").setView([53.79, -1.54], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap"
}).addTo(map);

let mainRouteLayer = null;
let altRouteLayer = null;
let bridgeMarkers = [];

/* ------------------------------------------
   FETCH ROUTE
------------------------------------------- */
document.getElementById("generateBtn").onclick = async () => {
    let start = document.getElementById("start").value.trim();
    let dest = document.getElementById("dest").value.trim();
    let height = parseFloat(document.getElementById("height").value);
    let avoid = document.getElementById("avoidBridges").checked;

    document.getElementById("statusBadge").innerText = "Loading…";

    const payload = {
        start_postcode: start,
        dest_postcode: dest,
        vehicle_height_m: height,
        avoid_low_bridges: avoid
    };

    try {
        const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("API error");

        const data = await res.json();
        document.getElementById("statusBadge").innerText = "Route ready";

        renderRoute(data);

    } catch (err) {
        console.error(err);
        document.getElementById("statusBadge").innerText = "Error";
        document.getElementById("summary").innerText =
            "Couldn't generate a route. Check the v2 service.";
    }
};

/* ------------------------------------------
   RENDER ROUTE ON MAP
------------------------------------------- */
function renderRoute(data) {
    // Clear layers
    if (mainRouteLayer) map.removeLayer(mainRouteLayer);
    if (altRouteLayer) map.removeLayer(altRouteLayer);
    bridgeMarkers.forEach(m => map.removeLayer(m));
    bridgeMarkers = [];

    // Summary
    document.getElementById("summary").innerHTML = `
        Distance: ${data.main_route.distance_km.toFixed(1)} km<br>
        Time: ${data.main_route.duration_min.toFixed(0)} mins<br>
        Bridge risk: ${data.bridge_risk}<br>
        Nearest bridge: ${data.nearest_bridge_height_m.toFixed(2)} m •
            ${data.nearest_bridge_distance_m.toFixed(0)} m
    `;

    // Main route
    mainRouteLayer = L.polyline(
        data.main_route.coords.map(c => [c[1], c[0]]),
        { color: "#3b82f6", weight: 5 }
    ).addTo(map);

    // Alternative
    if (data.alt_route && data.alt_route.coords.length > 0) {
        altRouteLayer = L.polyline(
            data.alt_route.coords.map(c => [c[1], c[0]]),
            { color: "#a855f7", weight: 4, dashArray: "6 8" }
        ).addTo(map);
    }

    // Bridge markers
    data.bridge_points.forEach(pt => {
        let m = L.circleMarker([pt.lat, pt.lon], {
            radius: 8,
            color: "#ff6b00",
            fillColor: "#ff6b00",
            fillOpacity: 1
        }).addTo(map);
        bridgeMarkers.push(m);
    });

    // Fit map
    const bounds = L.latLngBounds(
        data.main_route.coords.map(c => [c[1], c[0]])
    );
    map.fitBounds(bounds, { padding: [30, 30] });

    // Google Maps link
    buildGoogleMapsURL(data.main_route.coords);
}

/* ------------------------------------------
   OPEN IN GOOGLE MAPS
------------------------------------------- */
function buildGoogleMapsURL(coords) {
    let url = "https://www.google.com/maps/dir/?api=1&travelmode=driving&waypoints=";

    let wp = coords.map(c => `${c[1]},${c[0]}`).join("|");
    url += wp;

    document.getElementById("gmapsBtn").onclick = () => {
        window.open(url, "_blank");
    };
}

</script>

</body>
</html>