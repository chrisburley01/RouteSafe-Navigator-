<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RouteSafe Navigator</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg-main: radial-gradient(circle at 0% 0%, #1e1b4b, #020617 65%);
      --card-bg: rgba(15, 23, 42, 0.9);
      --card-border: rgba(148, 163, 184, 0.35);
      --accent: #6366f1;
      --accent-soft: #4f46e5;
      --accent-strong: #3b82f6;
      --text-main: #f9fafb;
      --text-subtle: #94a3b8;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #22c55e;
      --chip-bg: rgba(15, 23, 42, 0.9);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .hero-card {
      background: radial-gradient(circle at 0% 0%, #4f46e5, #1e1b4b 55%)
        padding-box;
      border-radius: 28px;
      padding: 24px 22px 26px;
      box-shadow: 0 30px 80px rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(191, 219, 254, 0.35);
      position: relative;
      overflow: hidden;
    }

    .hero-pill {
      position: absolute;
      right: 22px;
      top: 18px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.6);
      background: rgba(15, 23, 42, 0.35);
      font-size: 0.78rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .hero-title {
      font-size: 2.25rem;
      line-height: 1.1;
      font-weight: 800;
      letter-spacing: 0.02em;
      margin: 6px 0 4px;
    }

    .hero-subtitle {
      font-size: 0.98rem;
      color: #e5e7eb;
      opacity: 0.9;
    }

    .hero-tagline {
      margin-top: 10px;
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.9);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr);
      gap: 18px;
      margin-top: 22px;
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      }
    }

    .card {
      background: linear-gradient(
            135deg,
            rgba(30, 64, 175, 0.55),
            rgba(15, 23, 42, 0.96)
          )
          padding-box;
      border-radius: 24px;
      padding: 18px 18px 20px;
      border: 1px solid var(--card-border);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.85);
    }

    .card h2 {
      margin: 0 0 4px;
      font-size: 1.15rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .card-sub {
      font-size: 0.9rem;
      color: var(--text-subtle);
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-top: 10px;
      color: rgba(226, 232, 240, 0.9);
    }

    .field-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 10px;
    }

    .input,
    .input-dark {
      width: 100%;
      margin-top: 6px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.92);
      color: var(--text-main);
      font-size: 0.96rem;
      outline: none;
    }

    .input::placeholder,
    .input-dark::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }

    .input:focus,
    .input-dark:focus {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.8);
    }

    .reg-input-wrapper {
      position: relative;
    }

    .camera-chip {
      position: absolute;
      right: 4px;
      top: 7px;
      padding: 6px 10px;
      border-radius: 999px;
      background: radial-gradient(circle at 0% 0%, #f97316, #ea580c);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.72rem;
      border: 1px solid rgba(248, 250, 252, 0.7);
      color: #fefce8;
    }

    .camera-chip span {
      font-size: 0.9rem;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.9rem;
      color: rgba(226, 232, 240, 0.96);
    }

    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .primary-btn {
      width: 100%;
      margin-top: 16px;
      padding: 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent-strong), var(--accent));
      color: white;
      font-weight: 700;
      font-size: 1.02rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 18px 45px rgba(59, 130, 246, 0.55);
    }

    .primary-btn:disabled {
      cursor: default;
      opacity: 0.6;
      box-shadow: none;
    }

    .status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--text-subtle);
      gap: 10px;
      flex-wrap: wrap;
    }

    .status-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .status-pill.searching .status-dot {
      background: var(--warning);
      box-shadow: 0 0 0 4px rgba(234, 179, 8, 0.25);
    }

    .status-pill.ready .status-dot {
      background: var(--success);
      box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.28);
    }

    .status-pill.error .status-dot {
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(248, 113, 113, 0.25);
    }

    .status-label-strong {
      font-weight: 600;
    }

    .status-msg {
      margin-top: 4px;
      font-size: 0.78rem;
      color: rgba(148, 163, 184, 0.95);
    }

    /* Route summary / chips */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .summary-item {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 16px;
      padding: 10px 11px 11px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .summary-label {
      font-size: 0.8rem;
      color: var(--text-subtle);
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 0.98rem;
      font-weight: 600;
    }

    .risk-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .risk-low {
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.8);
    }

    .risk-medium {
      background: rgba(245, 158, 11, 0.16);
      color: #fed7aa;
      border: 1px solid rgba(251, 191, 36, 0.9);
    }

    .risk-high {
      background: rgba(220, 38, 38, 0.2);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.95);
    }

    .risk-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    .card-footnote {
      margin-top: 10px;
      font-size: 0.78rem;
      color: rgba(148, 163, 184, 0.95);
    }

    /* Map card */
    #map {
      margin-top: 12px;
      border-radius: 20px;
      overflow: hidden;
      height: 320px;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .map-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.78rem;
      color: var(--text-subtle);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .legend-swatch {
      width: 14px;
      height: 4px;
      border-radius: 999px;
      background: #60a5fa;
    }

    .legend-alt {
      background: #a855f7;
    }

    .legend-bridge {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97316;
    }

    .gmaps-btn {
      margin-top: 12px;
      width: 100%;
      padding: 11px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at 0% 0%, #22c55e1c, #020617);
      color: #e5e7eb;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
    }

    .gmaps-btn span {
      font-size: 1.1rem;
    }

    .gmaps-btn.disabled {
      opacity: 0.5;
      cursor: default;
    }

    footer {
      margin-top: 24px;
      font-size: 0.78rem;
      color: rgba(148, 163, 184, 0.9);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="page">
    <section class="hero-card">
      <div class="hero-pill">v1.1 Â· RouteSafe AI</div>
      <div class="hero-title">RouteSafe<br />Navigator</div>
      <div class="hero-subtitle">
        Intelligent low-bridge &amp; HGV routing engine.
      </div>
      <div class="hero-tagline">
        Uses RouteSafe engine Â· ORS HGV routing Â· UK bridge height data.
      </div>
    </section>

    <section class="grid">
      <!-- PLAN ROUTE CARD -->
      <div class="card">
        <h2>Plan route</h2>
        <div class="card-sub">
          Enter UK postcodes, vehicle height, and optionally scan the reg.
        </div>

        <label for="startPostcode">Start postcode</label>
        <input
          id="startPostcode"
          class="input"
          placeholder="LS27 0BN"
          autocomplete="off"
        />

        <label for="destPostcode">Destination postcode</label>
        <input
          id="destPostcode"
          class="input"
          placeholder="HD5 0RL"
          autocomplete="off"
        />

        <div class="field-row">
          <div>
            <label for="vehicleHeight">Vehicle height (m)</label>
            <input
              id="vehicleHeight"
              class="input"
              type="number"
              step="0.1"
              min="2"
              max="6.5"
              value="4.5"
            />
          </div>
          <div>
            <label for="vehicleReg">Vehicle reg (optional)</label>
            <div class="reg-input-wrapper">
              <input
                id="vehicleReg"
                class="input"
                placeholder="e.g. YX71 OXC"
                autocomplete="off"
              />
              <div class="camera-chip">
                <span>ðŸ“·</span> Scan
              </div>
            </div>
          </div>
        </div>

        <label class="checkbox-row">
          <input id="avoidLowBridges" type="checkbox" checked />
          <span>Avoid low bridges</span>
        </label>

        <button id="generateBtn" class="primary-btn">
          <span id="generateLabel">Generate safe route</span>
        </button>

        <div class="status-row">
          <div id="statusPill" class="status-pill">
            <div class="status-dot"></div>
            <span class="status-label-strong" id="statusLabel">Idle</span>
          </div>
          <div class="status-msg" id="statusMsg">
            Ready when you are.
          </div>
        </div>
      </div>

      <!-- SUMMARY CARD -->
      <div class="card">
        <h2>Route summary</h2>
        <div class="card-sub">
          Distance, ETA, and nearest low bridge on your selected route.
        </div>

        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">Distance</div>
            <div class="summary-value" id="distanceValue">â€“</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Estimated time</div>
            <div class="summary-value" id="timeValue">â€“</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Bridge risk</div>
            <div class="summary-value" id="bridgeRisk">â€“</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Nearest bridge</div>
            <div class="summary-value" id="nearestBridge">â€“</div>
          </div>
        </div>

        <div class="card-footnote" id="summaryFootnote">
          No route generated yet.
        </div>
      </div>
    </section>

    <!-- MAP CARD -->
    <section class="card" style="margin-top: 18px;">
      <h2>Map</h2>
      <div class="card-sub">
        RouteSafe engine Â· ORS routing Â· UK bridge data.
      </div>

      <div id="map"></div>

      <div class="map-legend">
        <div class="legend-item">
          <div class="legend-swatch"></div>
          <span>Main route</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch legend-alt"></div>
          <span>Alternative route</span>
        </div>
        <div class="legend-item">
          <div class="legend-bridge"></div>
          <span>Low bridge</span>
        </div>
      </div>

      <button id="gmapsBtn" class="gmaps-btn disabled">
        <span>ðŸ§­</span> <span>Open in Google Maps</span>
      </button>
    </section>

    <footer>
      Â© RouteSafe Navigator Â· Prototype preview â€“ not for live navigation.
    </footer>
  </div>

  <script>
    // ---------- CONFIG ----------
    const API_URL =
      "https://routesafe-navigatorv2.onrender.com/api/route";

    // ---------- MAP SETUP ----------
    let map = L.map("map", {
      zoomControl: true,
      attributionControl: true,
    }).setView([53.79, -1.6], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "Â© OpenStreetMap contributors",
    }).addTo(map);

    let mainRouteLayer = null;
    let altRouteLayer = null;
    let bridgeMarkers = [];
    let gmapsUrl = null;

    function clearMapLayers() {
      if (mainRouteLayer) {
        map.removeLayer(mainRouteLayer);
        mainRouteLayer = null;
      }
      if (altRouteLayer) {
        map.removeLayer(altRouteLayer);
        altRouteLayer = null;
      }
      bridgeMarkers.forEach((m) => map.removeLayer(m));
      bridgeMarkers = [];
    }

    // ---------- STATUS HELPERS ----------
    const statusPill = document.getElementById("statusPill");
    const statusLabel = document.getElementById("statusLabel");
    const statusMsg = document.getElementById("statusMsg");
    const generateBtn = document.getElementById("generateBtn");
    const generateLabel = document.getElementById("generateLabel");

    function setStatusIdle() {
      statusPill.classList.remove("searching", "ready", "error");
      statusLabel.textContent = "Idle";
      statusMsg.textContent = "Ready when you are.";
      generateBtn.disabled = false;
      generateLabel.textContent = "Generate safe route";
    }

    function setStatusSearching() {
      statusPill.classList.remove("ready", "error");
      statusPill.classList.add("searching");
      statusLabel.textContent = "Searching";
      statusMsg.textContent = "Planning low-bridge aware HGV routeâ€¦";
      generateBtn.disabled = true;
      generateLabel.textContent = "Planning routeâ€¦";
    }

    function setStatusReady() {
      statusPill.classList.remove("searching", "error");
      statusPill.classList.add("ready");
      statusLabel.textContent = "Route ready";
      statusMsg.textContent =
        "Preview the map or open in Google Maps to navigate.";
      generateBtn.disabled = false;
      generateLabel.textContent = "Generate safe route";
    }

    function setStatusError(message) {
      statusPill.classList.remove("searching", "ready");
      statusPill.classList.add("error");
      statusLabel.textContent = "Error";
      statusMsg.textContent =
        message ||
        "Couldn't generate a route. Check the v2 service or try again.";
      generateBtn.disabled = false;
      generateLabel.textContent = "Generate safe route";
    }

    setStatusIdle();

    // ---------- SUMMARY HELPERS ----------
    const distanceValue = document.getElementById("distanceValue");
    const timeValue = document.getElementById("timeValue");
    const bridgeRisk = document.getElementById("bridgeRisk");
    const nearestBridge = document.getElementById("nearestBridge");
    const summaryFootnote = document.getElementById("summaryFootnote");

    function formatKm(km) {
      if (!isFinite(km)) return "â€“";
      return km.toFixed(1) + " km";
    }

    function formatMins(mins) {
      if (!isFinite(mins)) return "â€“";
      return Math.round(mins) + " mins";
    }

    function formatBridgeHeight(h) {
      if (!isFinite(h)) return "â€“";
      return h.toFixed(2) + " m";
    }

    function formatMetres(m) {
      if (!isFinite(m)) return "â€“";
      return Math.round(m) + " m";
    }

    function setRiskLabel(risk) {
      const text = risk || "Unknown";
      bridgeRisk.textContent = text;

      bridgeRisk.classList.remove("risk-pill", "risk-low", "risk-medium", "risk-high");

      if (!risk || risk === "None") return;

      let cls = "risk-medium";
      if (risk.toLowerCase() === "low") cls = "risk-low";
      if (risk.toLowerCase() === "medium") cls = "risk-medium";
      if (risk.toLowerCase() === "high" || risk.toLowerCase() === "conflict")
        cls = "risk-high";

      bridgeRisk.classList.add("risk-pill", cls);
    }

    function resetSummary() {
      distanceValue.textContent = "â€“";
      timeValue.textContent = "â€“";
      bridgeRisk.textContent = "No route";
      bridgeRisk.classList.remove("risk-pill", "risk-low", "risk-medium", "risk-high");
      nearestBridge.textContent = "â€“";
      summaryFootnote.textContent = "No route generated yet.";
    }

    resetSummary();

    // ---------- GOOGLE MAPS ----------
    const gmapsBtn = document.getElementById("gmapsBtn");
    gmapsBtn.addEventListener("click", () => {
      if (!gmapsUrl) return;
      window.open(gmapsUrl, "_blank");
    });

    function updateGmapsLink(coords) {
      if (!coords || !coords.length) {
        gmapsUrl = null;
        gmapsBtn.classList.add("disabled");
        return;
      }

      // coords are [lon, lat]
      const waypoints = coords
        .map((c) => `${c[1]},${c[0]}`)
        .join("|")
        .slice(0, 1800); // keep URL reasonable

      gmapsUrl = `https://www.google.com/maps/dir/?api=1&travelmode=driving&waypoints=${encodeURIComponent(
        waypoints
      )}`;
      gmapsBtn.classList.remove("disabled");
    }

    // ---------- RENDER ROUTE ----------
    function renderRoute(data) {
      clearMapLayers();

      const main = data.main_route;
      const alt = data.alt_route;
      const metrics = data.metrics || {};
      const bridgeRes = data.bridge_result || {};

      const coordsMain = (main && main.coords) || [];
      const coordsAlt = (alt && alt.coords) || [];

      // Summary
      distanceValue.textContent = formatKm(metrics.distance_km || main.distance_km);
      timeValue.textContent = formatMins(metrics.duration_min || main.duration_min);
      setRiskLabel(bridgeRes.risk_level || data.bridge_risk || "Unknown");

      if (
        bridgeRes.nearest_bridge_height_m != null &&
        bridgeRes.nearest_bridge_distance_m != null
      ) {
        nearestBridge.textContent =
          formatBridgeHeight(bridgeRes.nearest_bridge_height_m) +
          " Â· " +
          formatMetres(bridgeRes.nearest_bridge_distance_m);
      } else if (
        data.nearest_bridge_height_m != null &&
        data.nearest_bridge_distance_m != null
      ) {
        nearestBridge.textContent =
          formatBridgeHeight(data.nearest_bridge_height_m) +
          " Â· " +
          formatMetres(data.nearest_bridge_distance_m);
      } else {
        nearestBridge.textContent = "None on analysed leg";
      }

      summaryFootnote.textContent =
        "Planned route uses RouteSafe engine Â· ORS HGV routing Â· UK bridge data.";

      // Draw main route
      if (coordsMain.length) {
        const latLngs = coordsMain.map((c) => [c[1], c[0]]);
        mainRouteLayer = L.polyline(latLngs, {
          color: "#3b82f6",
          weight: 5,
        }).addTo(map);
        map.fitBounds(mainRouteLayer.getBounds(), { padding: [30, 30] });
      }

      // Draw alt route
      if (coordsAlt.length) {
        const latLngsAlt = coordsAlt.map((c) => [c[1], c[0]]);
        altRouteLayer = L.polyline(latLngsAlt, {
          color: "#a855f7",
          weight: 4,
          dashArray: "6 10",
        }).addTo(map);
      }

      // Low bridge markers (if returned)
      const bridgePoints = data.bridge_points || bridgeRes.nearby_bridges || [];
      bridgePoints.forEach((b) => {
        const lat = b.lat || b.latitude;
        const lon = b.lon || b.longitude;
        if (lat == null || lon == null) return;
        const marker = L.circleMarker([lat, lon], {
          radius: 7,
          color: "#f97316",
          fillColor: "#f97316",
          fillOpacity: 1,
        })
          .addTo(map)
          .bindPopup(
            `Low bridge<br/>Height: ${
              b.height_m ? b.height_m.toFixed(2) + " m" : "unknown"
            }`
          );
        bridgeMarkers.push(marker);
      });

      updateGmapsLink(coordsMain);
    }

    // ---------- GENERATE CLICK ----------
    document
      .getElementById("generateBtn")
      .addEventListener("click", async () => {
        const start = document
          .getElementById("startPostcode")
          .value.trim();
        const dest = document.getElementById("destPostcode").value.trim();
        const height = parseFloat(
          document.getElementById("vehicleHeight").value
        );
        const avoid = document.getElementById("avoidLowBridges").checked;

        if (!start || !dest || !height) {
          setStatusError("Please enter start, destination and vehicle height.");
          return;
        }

        setStatusSearching();
        resetSummary();
        clearMapLayers();
        updateGmapsLink(null);

        const payload = {
          start_postcode: start,
          dest_postcode: dest,
          vehicle_height_m: height,
          avoid_low_bridges: avoid,
        };

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const text = await res.text();
            console.error("API error", res.status, text);
            setStatusError(
              `API ${res.status}. Couldn't generate a route.`
            );
            return;
          }

          const data = await res.json();
          renderRoute(data);
          setStatusReady();
        } catch (err) {
          console.error(err);
          setStatusError(
            "Network error talking to v2 service. Check Render status."
          );
        }
      });
  </script>
</body>
</html>