<script>
/* ===========================================================
   ROUTESAFE NAVIGATOR – FRONTEND JS
   Fully updated for v2 API (distance_km, duration_min, geometry)
   =========================================================== */

let map, mainRouteLayer, altRouteLayer, bridgeLayer;

function initMap() {
  map = L.map("map").setView([53.8, -1.55], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 20,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  mainRouteLayer = L.layerGroup().addTo(map);
  altRouteLayer = L.layerGroup().addTo(map);
  bridgeLayer = L.layerGroup().addTo(map);
}

/* ===========================================================
   MAIN FUNCTION — CALL API + RENDER MAP + UPDATE SUMMARY
   =========================================================== */
async function generateRoute() {
  const start = document.getElementById("start").value.trim();
  const dest = document.getElementById("dest").value.trim();
  const height = parseFloat(
    document.getElementById("vehicle-height").value.trim()
  );
  const avoid = document.getElementById("avoid-low-bridges").checked;

  if (!start || !dest || isNaN(height)) {
    alert("Please enter valid postcodes and vehicle height.");
    return;
  }

  const payload = {
    start_postcode: start,
    dest_postcode: dest,
    vehicle_height_m: height,
    avoid_low_bridges: avoid
  };

  try {
    const response = await fetch(
      "https://routesafe-navigatorv2.onrender.com/api/route",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );

    if (!response.ok) {
      alert("Sorry – couldn’t generate a route. Check the v2 service.");
      return;
    }

    const data = await response.json();
    renderRouteOnMap(data);
    updateSummaryPanels(data);
  } catch (err) {
    alert("Error contacting service.");
    console.error(err);
  }
}

/* ===========================================================
   MAP RENDER
   =========================================================== */
function renderRouteOnMap(data) {
  mainRouteLayer.clearLayers();
  altRouteLayer.clearLayers();
  bridgeLayer.clearLayers();

  if (data.main_route && data.main_route.coords) {
    const mainCoords = data.main_route.coords.map((c) => [c[1], c[0]]);
    const mainLine = L.polyline(mainCoords, { color: "#417BFF", weight: 4 });
    mainRouteLayer.addLayer(mainLine);
    map.fitBounds(mainLine.getBounds(), { padding: [40, 40] });
  }

  if (data.alt_route && data.alt_route.coords) {
    const altCoords = data.alt_route.coords.map((c) => [c[1], c[0]]);
    const altLine = L.polyline(altCoords, { color: "#9A4DFF", weight: 3 });
    altRouteLayer.addLayer(altLine);
  }

  if (data.bridges && Array.isArray(data.bridges)) {
    data.bridges.forEach((b) => {
      L.circleMarker([b.lat, b.lon], {
        radius: 6,
        color: "#ff8800",
        fillColor: "#ff8800",
        fillOpacity: 1
      })
        .bindPopup(`Low bridge: ${b.height_m}m<br>${b.distance_m}m away`)
        .addTo(bridgeLayer);
    });
  }
}

/* ===========================================================
   SUMMARY PANEL UPDATES
   =========================================================== */
function updateSummaryPanels(data) {
  const risk = data.bridge_result?.risk_level || "Unknown";
  const nearestHeight =
    data.bridge_result?.nearest_bridge_height_m ?? "-";
  const nearestDist =
    data.bridge_result?.nearest_bridge_distance_m ?? "-";

  // Update risk badge
  const badge = document.getElementById("risk-badge");
  badge.textContent = risk;
  badge.className = "badge " + risk.toLowerCase();

  document.getElementById("bridge-risk").textContent =
    risk === "High" ? "⚠ Bridge conflict" : risk;

  document.getElementById("nearest-bridge").textContent =
    nearestHeight !== "-"
      ? `${nearestHeight}m (${nearestDist}m away)`
      : "-";

  // ======================================================
  // METRICS — distance & time from v2 backend
  // ======================================================
  const metrics =
    data.metrics ||
    data.main_route ||
    {};

  const distanceKm =
    typeof metrics.distance_km === "number"
      ? metrics.distance_km
      : null;

  const durationMin =
    typeof metrics.duration_min === "number"
      ? metrics.duration_min
      : null;

  document.getElementById("summary-distance").textContent =
    distanceKm ? distanceKm.toFixed(1) + " km" : "-";

  document.getElementById("summary-time").textContent =
    durationMin ? durationMin.toFixed(0) + " mins" : "-";

  // Optional – extended status line
  const statusEl = document.getElementById("route-summary-status");
  if (statusEl && distanceKm && durationMin) {
    statusEl.textContent =
      `Planned route: ${distanceKm.toFixed(1)} km · ${durationMin.toFixed(0)} mins · Risk ${risk}`;
  }
}
</script>